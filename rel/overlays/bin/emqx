#!/bin/bash
# -*- tab-width:4;indent-tabs-mode:nil -*-
# ex: ts=4 sw=4 et

set -euo pipefail

BASE="$(cd "$(dirname "$(readlink "$0" || echo "$0")")"/..; pwd -P)"
# shellcheck disable=SC1090,SC1091
source "$BASE/bin/common_defs.sh"
# shellcheck disable=SC1090,SC1091
source "$BASE/bin/common_functions.sh"

# Make sure log directory exists
mkdir -p "$RUNNER_LOG_DIR"

# Make sure data directory exists
mkdir -p "$RUNNER_DATA_DIR"

# Make sure data/configs exists
mkdir -p "$CONFIGS_DIR"

COMMAND="${1:-}"

## IS_BOOT_COMMAND is set for later to inspect node name and cookie
## from hocon config (or env variable), which resides in
## `common_defs2.sh`.
case "${COMMAND}" in
    daemon|daemon_iex|start|start_iex)
        IS_BOOT_COMMAND='yes'
        ;;
    *)
        IS_BOOT_COMMAND='no'
        ;;
esac
export IS_BOOT_COMMAND

# shellcheck disable=SC1090,SC1091
source "$BASE/bin/common_defs2.sh"

cd "$ROOTDIR"

# FIXME!!! Create case for commands.
generate_config "$NAME_TYPE" "$NAME"
# Must be explicitly exported here in order to be picked up correctly
export RELEASE_SYS_CONFIG
export RELEASE_TMP="$RUNNER_ROOT_DIR"

exec bin/emqx_base "$@"
